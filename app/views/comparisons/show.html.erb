<main class="bg-white text-main">
  <section class="mx-auto max-w-7xl px-6 py-12">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.25em] text-stone-400">Compare</p>
        <h1 class="mt-2 text-3xl font-semibold font-['Fraunces']">商品比較</h1>
        <p class="mt-2 text-sm text-stone-500">最大3つまで選んで、価格と評価を並べて確認できます。</p>
      </div>
      <%= button_to "比較をクリア", compare_path, method: :delete,
        class: "rounded-full border border-base px-4 py-2 text-xs font-semibold text-stone-600 hover:border-stone-300" %>
    </div>

    <% ids = compared_product_ids %>
    <% if ids.any? %>
      <% products_by_id = Product.where(id: ids).index_by(&:id) %>
      <% products = ids.filter_map { |id| products_by_id[id] } %>
      <div class="mt-8 overflow-x-auto rounded-3xl border border-base bg-white shadow-sm">
        <table class="min-w-full text-left text-sm">
          <thead class="bg-stone-50 text-stone-600">
            <tr>
              <th class="px-6 py-4 text-xs font-semibold uppercase tracking-[0.2em]">商品</th>
              <% products.each do |product| %>
                <th class="px-6 py-4">
                  <div class="flex min-w-[220px] flex-col gap-3">
                    <div class="h-28 w-28 overflow-hidden rounded-2xl bg-stone-100">
                      <% if product.image_url.present? %>
                        <%= image_tag product.image_url, class: "h-full w-full object-cover", alt: product.name %>
                      <% end %>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-stone-900"><%= product.name %></p>
                      <p class="text-xs text-stone-500"><%= product.brand %> ・ <%= product.flavor %></p>
                    </div>
                  </div>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody class="divide-y divide-base">
            <tr>
              <th class="px-6 py-4 text-sm font-semibold text-stone-700">価格</th>
              <% products.each do |product| %>
                <td class="px-6 py-4 text-sm font-semibold text-stone-700">
                  <%= number_to_currency(product.price, unit: "¥", precision: 0, format: "%u%n") %>
                </td>
              <% end %>
            </tr>
            <tr>
              <th class="px-6 py-4 text-sm font-semibold text-stone-700">総合満足度</th>
              <% products.each do |product| %>
                <% avg = product.product_stat&.avg_overall_score %>
                <td class="px-6 py-4 text-sm text-stone-600">
                  <% if avg.present? %>
                    <span class="text-amber-400"><%= "★" * avg.round %><%= "☆" * (5 - avg.round) %></span>
                    <span class="ml-2 font-semibold text-stone-700"><%= format("%.1f", avg) %>/5.0</span>
                  <% else %>
                    <span class="text-stone-400">未集計</span>
                  <% end %>
                </td>
              <% end %>
            </tr>

            <% axis_rows = {
              sweetness: ["甘くない", "やや甘くない", "普通", "やや甘め", "甘め"],
              richness: ["薄め", "やや薄め", "普通", "やや濃いめ", "濃いめ"],
              aftertaste: ["スッキリ", "ややスッキリ", "普通", "やや重め", "重い"],
              flavor_score: ["香りはしない", "香り控えめ", "普通", "やや香り豊か", "香り豊か"],
              solubility: ["溶けにくい", "やや溶けにくい", "普通", "やや溶けやすい", "溶けやすい"],
              foam: ["泡立ちにくい", "やや泡立ちにくい", "普通", "やや泡立つ", "泡立つ"]
            } %>

            <% axis_rows.each do |key, labels| %>
              <tr>
                <th class="px-6 py-4 text-sm font-semibold text-stone-700"><%= labels[2] %></th>
                <% products.each do |product| %>
                  <% avg = product.product_stat&.public_send("avg_#{key}") %>
                  <td class="px-6 py-4 text-sm text-stone-600">
                    <% if avg.present? %>
                      <% index = [[avg.round, 1].max, 5].min - 1 %>
                      <span class="text-stone-700"><%= labels[index] %></span>
                    <% else %>
                      <span class="text-stone-400">未集計</span>
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="mt-8 rounded-3xl border border-dashed border-base bg-white p-8 text-center text-sm text-stone-500">
        比較中の商品がありません。
      </div>
    <% end %>
  </section>
</main>
