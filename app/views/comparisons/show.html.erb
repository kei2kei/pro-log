<main class="bg-white text-main">
  <section class="mx-auto max-w-7xl px-6 py-12">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.25em] text-stone-400"><%= t("comparisons.show.kicker") %></p>
        <h1 class="mt-2 text-3xl font-semibold font-['Fraunces']"><%= t("comparisons.show.title") %></h1>
        <p class="mt-2 text-sm text-stone-500"><%= t("comparisons.show.subtitle") %></p>
      </div>
      <%= button_to t("comparisons.show.clear"), compare_path, method: :delete,
        form: { data: { turbo: false } },
        class: "rounded-full border border-base px-4 py-2 text-xs font-semibold text-stone-600 hover:border-stone-300" %>
    </div>

    <% ids = compared_product_ids %>
    <% if ids.any? %>
      <% products_by_id = Product.where(id: ids).index_by(&:id) %>
      <% products = ids.filter_map { |id| products_by_id[id] } %>
      <% value_cell_class = "px-4 py-3 text-sm text-stone-700 sm:px-6 sm:py-4" %>
      <div class="mt-8 overflow-x-auto rounded-3xl border border-base bg-white shadow-sm">
        <table class="w-full min-w-[860px] text-left text-xs sm:text-sm">
          <thead class="bg-stone-50 text-stone-600">
            <tr>
              <th class="w-28 px-4 py-3 text-[11px] font-semibold uppercase tracking-[0.15em] sm:w-40 sm:px-6 sm:py-4 sm:text-xs sm:tracking-[0.2em]"><%= t("comparisons.show.table.product") %></th>
              <% products.each do |product| %>
                <th class="px-4 py-3 sm:px-6 sm:py-4">
                  <div class="flex min-w-[200px] flex-col gap-2 sm:min-w-[220px] sm:gap-3">
                    <%= link_to product_path(product), class: "block h-20 w-20 overflow-hidden rounded-xl bg-stone-100 sm:h-28 sm:w-28 sm:rounded-2xl" do %>
                      <% if product.image_url.present? %>
                        <%= image_tag product.image_url, class: "h-full w-full object-cover", alt: product.name %>
                      <% end %>
                    <% end %>
                    <div>
                      <p class="line-clamp-2 text-xs font-semibold text-stone-900 sm:text-sm">
                        <%= link_to product.name, product_path(product), class: "hover:underline" %>
                      </p>
                      <p class="line-clamp-2 text-[11px] text-stone-500 sm:text-xs"><%= product.brand %> ・ <%= product.flavor %></p>
                    </div>
                  </div>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody class="divide-y divide-base">
            <tr>
              <th class="px-4 py-3 text-xs font-semibold text-stone-700 sm:px-6 sm:py-4 sm:text-sm"><%= t("comparisons.show.table.price") %></th>
              <% products.each do |product| %>
                <td class="<%= value_cell_class %>">
                  <%= number_to_currency(product.price, unit: "¥", precision: 0, format: "%u%n") %>
                </td>
              <% end %>
            </tr>
            <tr>
              <th class="px-4 py-3 text-xs font-semibold text-stone-700 sm:px-6 sm:py-4 sm:text-sm"><%= t("comparisons.show.table.calorie") %></th>
              <% products.each do |product| %>
                <td class="<%= value_cell_class %>">
                  <% if product.calorie.present? %>
                    <%= product.calorie %>kcal
                  <% else %>
                    <span class="text-sm text-stone-400"><%= t("comparisons.show.unaggregated") %></span>
                  <% end %>
                </td>
              <% end %>
            </tr>
            <tr>
              <th class="px-4 py-3 text-xs font-semibold text-stone-700 sm:px-6 sm:py-4 sm:text-sm"><%= t("comparisons.show.table.pfc") %></th>
              <% products.each do |product| %>
                <td class="<%= value_cell_class %>">
                  <% if product.protein.present? || product.fat.present? || product.carbohydrate.present? %>
                    P:<%= product.protein || "-" %>g / F:<%= product.fat || "-" %>g / C:<%= product.carbohydrate || "-" %>g
                  <% else %>
                    <span class="text-sm text-stone-400"><%= t("comparisons.show.unaggregated") %></span>
                  <% end %>
                </td>
              <% end %>
            </tr>
            <tr>
              <th class="px-4 py-3 text-xs font-semibold text-stone-700 sm:px-6 sm:py-4 sm:text-sm"><%= t("comparisons.show.table.overall") %></th>
              <% products.each do |product| %>
                <% avg = product.product_stat&.avg_overall_score %>
                <td class="<%= value_cell_class %>">
                  <% if avg.present? %>
                    <span class="text-amber-400"><%= "★" * avg.round %><%= "☆" * (5 - avg.round) %></span>
                    <span class="ml-1 sm:ml-2"><%= format("%.1f", avg) %>/5.0</span>
                  <% else %>
                    <span class="text-sm text-stone-400"><%= t("comparisons.show.unaggregated") %></span>
                  <% end %>
                </td>
              <% end %>
            </tr>

            <% axis_rows = {
              sweetness: t("comparisons.show.table.axis.sweetness"),
              richness: t("comparisons.show.table.axis.richness"),
              aftertaste: t("comparisons.show.table.axis.aftertaste"),
              flavor_score: t("comparisons.show.table.axis.flavor_score"),
              solubility: t("comparisons.show.table.axis.solubility"),
              foam: t("comparisons.show.table.axis.foam")
            } %>

            <% axis_rows.each do |key, label| %>
              <tr>
                <th class="px-4 py-3 text-xs font-semibold text-stone-700 sm:px-6 sm:py-4 sm:text-sm"><%= label %></th>
                <% products.each do |product| %>
                  <% avg = product.product_stat&.public_send("avg_#{key}") %>
                  <td class="<%= value_cell_class %>">
                    <% if avg.present? %>
                      <%= axis_label_for_avg(key, avg) %>
                    <% else %>
                      <span class="text-sm text-stone-400"><%= t("comparisons.show.unaggregated") %></span>
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="mt-8 rounded-3xl border border-dashed border-base bg-white p-8 text-center text-sm text-stone-500">
        <%= t("comparisons.show.empty_state") %>
      </div>
    <% end %>
  </section>
</main>
