<main class="bg-white text-main">
  <section class="mx-auto max-w-7xl px-6 py-12">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.25em] text-stone-400"><%= t("comparisons.show.kicker") %></p>
        <h1 class="mt-2 text-3xl font-semibold font-['Fraunces']"><%= t("comparisons.show.title") %></h1>
        <p class="mt-2 text-sm text-stone-500"><%= t("comparisons.show.subtitle") %></p>
      </div>
      <%= button_to t("comparisons.show.clear"), compare_path, method: :delete,
        class: "rounded-full border border-base px-4 py-2 text-xs font-semibold text-stone-600 hover:border-stone-300" %>
    </div>

    <% ids = compared_product_ids %>
    <% if ids.any? %>
      <% products_by_id = Product.where(id: ids).index_by(&:id) %>
      <% products = ids.filter_map { |id| products_by_id[id] } %>
      <div class="mt-8 overflow-x-auto rounded-3xl border border-base bg-white shadow-sm">
        <table class="min-w-full text-left text-sm">
          <thead class="bg-stone-50 text-stone-600">
            <tr>
              <th class="px-6 py-4 text-xs font-semibold uppercase tracking-[0.2em]"><%= t("comparisons.show.table.product") %></th>
              <% products.each do |product| %>
                <th class="px-6 py-4">
                  <div class="flex min-w-[220px] flex-col gap-3">
                    <div class="h-28 w-28 overflow-hidden rounded-2xl bg-stone-100">
                      <% if product.image_url.present? %>
                        <%= image_tag product.image_url, class: "h-full w-full object-cover", alt: product.name %>
                      <% end %>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-stone-900"><%= product.name %></p>
                      <p class="text-xs text-stone-500"><%= product.brand %> ・ <%= product.flavor %></p>
                    </div>
                  </div>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody class="divide-y divide-base">
            <tr>
              <th class="px-6 py-4 text-sm font-semibold text-stone-700"><%= t("comparisons.show.table.price") %></th>
              <% products.each do |product| %>
                <td class="px-6 py-4 text-sm font-semibold text-stone-700">
                  <%= number_to_currency(product.price, unit: "¥", precision: 0, format: "%u%n") %>
                </td>
              <% end %>
            </tr>
            <tr>
              <th class="px-6 py-4 text-sm font-semibold text-stone-700"><%= t("comparisons.show.table.overall") %></th>
              <% products.each do |product| %>
                <% avg = product.product_stat&.avg_overall_score %>
                <td class="px-6 py-4 text-sm text-stone-600">
                  <% if avg.present? %>
                    <span class="text-amber-400"><%= "★" * avg.round %><%= "☆" * (5 - avg.round) %></span>
                    <span class="ml-2 font-semibold text-stone-700"><%= format("%.1f", avg) %>/5.0</span>
                  <% else %>
                    <span class="text-stone-400"><%= t("comparisons.show.unaggregated") %></span>
                  <% end %>
                </td>
              <% end %>
            </tr>

            <% axis_rows = {
              sweetness: t("comparisons.show.table.axis.sweetness"),
              richness: t("comparisons.show.table.axis.richness"),
              aftertaste: t("comparisons.show.table.axis.aftertaste"),
              flavor_score: t("comparisons.show.table.axis.flavor_score"),
              solubility: t("comparisons.show.table.axis.solubility"),
              foam: t("comparisons.show.table.axis.foam")
            } %>

            <% axis_rows.each do |key, label| %>
              <tr>
                <th class="px-6 py-4 text-sm font-semibold text-stone-700"><%= label %></th>
                <% products.each do |product| %>
                  <% avg = product.product_stat&.public_send("avg_#{key}") %>
                  <td class="px-6 py-4 text-sm text-stone-600">
                    <% if avg.present? %>
                      <span class="text-stone-700"><%= axis_label_for_avg(key, avg) %></span>
                    <% else %>
                      <span class="text-stone-400"><%= t("comparisons.show.unaggregated") %></span>
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="mt-8 rounded-3xl border border-dashed border-base bg-white p-8 text-center text-sm text-stone-500">
        <%= t("comparisons.show.empty_state") %>
      </div>
    <% end %>
  </section>
</main>
