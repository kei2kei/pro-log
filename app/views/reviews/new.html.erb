<main class="min-h-screen bg-stone-50 text-stone-900">
  <section class="border-b border-stone-200 bg-white">
    <div class="mx-auto max-w-6xl px-6 py-12">
      <p class="text-xs uppercase tracking-[0.4em] text-emerald-600">Review</p>
      <h1 class="mt-4 text-4xl font-semibold font-['Fraunces']">プロテインのレビュー作成</h1>
    </div>
  </section>

  <section class="mx-auto max-w-4xl px-6 py-12">
    <div class="rounded-3xl border border-stone-200 bg-white p-8 shadow-sm">
      <%= render "devise/shared/error_messages", resource: @review %>

      <div class="grid gap-8 md:grid-cols-[1fr_220px] md:items-center">
        <div>
          <p class="text-sm text-stone-500">レビューする商品</p>
          <h2 class="mt-2 text-2xl font-semibold"><%= @product.name %></h2>
          <p class="mt-1 text-sm text-stone-500"><%= @product.brand %></p>
        </div>
        <div class="aspect-square overflow-hidden rounded-2xl bg-stone-100">
          <% if @product.image.attached? %>
            <%= image_tag @product.image.variant(resize_to_fill: [320, 320]), class: "h-full w-full object-cover", alt: @product.name %>
          <% else %>
            <div class="flex h-full w-full items-center justify-center text-sm text-stone-400">
              No Image
            </div>
          <% end %>
        </div>
      </div>

      <%= form_with model: [@product, @review], class: "mt-10 space-y-8" do |f| %>
        <div class="rounded-2xl border border-stone-200 bg-stone-50 px-6 py-5">
          <div class="flex flex-wrap items-center gap-4">
            <span class="text-sm font-semibold text-stone-700">総合満足度</span>
            <div class="flex flex-row-reverse items-center gap-1">
              <% 5.downto(1) do |score| %>
                <%= radio_button_tag "review[overall_score]", score, @review.overall_score.to_i == score,
                  id: "review_overall_score_#{score}", class: "peer sr-only" %>
                <label for="review_overall_score_<%= score %>" class="cursor-pointer text-2xl text-stone-300 peer-checked:text-amber-400 peer-checked~label:text-amber-400">
                  ★
                </label>
              <% end %>
            </div>
            <span id="overall-score-value" class="ml-auto text-sm font-semibold text-stone-700"></span>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-[160px_1fr]">
          <p class="text-sm font-semibold text-stone-700">レビュータイトル</p>
          <%= f.text_field :title, class: "w-full rounded-2xl border border-stone-200 bg-white px-4 py-3 text-sm focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200" %>
        </div>

        <div class="grid gap-6 md:grid-cols-[160px_1fr]">
          <p class="text-sm font-semibold text-stone-700">レビュー内容</p>
          <%= f.text_area :comment, rows: 5, class: "w-full rounded-2xl border border-stone-200 bg-white px-4 py-3 text-sm focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200" %>
        </div>

        <div class="grid gap-6 md:grid-cols-[160px_1fr]">
          <div>
            <p class="text-sm font-semibold text-stone-700">タグ</p>
            <p class="mt-1 text-xs text-stone-400">カンマ・スペース区切りで入力</p>
          </div>
          <%= f.text_field :tag_names, value: @review.tag_names, placeholder: "例: チョコ, 甘め など", class: "w-full rounded-2xl border border-stone-200 bg-white px-4 py-3 text-sm focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200" %>
        </div>

        <div class="space-y-6">
          <h3 class="text-lg font-semibold text-stone-900">各項目の評価</h3>
          <% [
            [:sweetness, "甘さ", ["甘め", "やや甘め", "普通", "やや甘くない", "甘くない"]],
            [:richness, "濃さ", ["濃いめ", "やや濃いめ", "普通", "やや薄め", "薄め"]],
            [:aftertaste, "後味", ["重い", "やや重め", "普通", "ややスッキリ", "スッキリ"]],
            [:flavor_score, "風味", ["香り豊か", "やや香り豊か", "普通", "香り控えめ", "香りはしない"]],
            [:solubility, "溶けやすさ", ["溶けやすい", "やや溶けやすい", "普通", "やや溶けにくい", "溶けにくい"]],
            [:foam, "泡立ち", ["泡立つ", "やや泡立つ", "普通", "やや泡立ちにくい", "泡立ちにくい"]]
          ].each do |field, label, labels| %>
            <% l1, l2, l3, l4, l5 = labels %>
            <div class="grid gap-4 md:grid-cols-[140px_1fr] md:items-start">
              <div class="pt-3 text-sm font-semibold text-stone-700"><%= label %></div>
              <div class="relative w-full pb-7">
                <%= f.range_field field, in: 1..5, step: 1, value: f.object.public_send(field) || 3,
                  class: "rating-range w-full h-2 rounded-full bg-stone-200 appearance-none cursor-pointer" %>
                <span class="absolute left-0 top-5 text-[10px] text-stone-400 md:text-xs"><%= l1 %></span>
                <span class="absolute left-1/4 top-5 -translate-x-1/2 text-[10px] text-stone-400 md:text-xs"><%= l2 %></span>
                <span class="absolute left-1/2 top-5 -translate-x-1/2 text-[10px] text-stone-400 md:text-xs"><%= l3 %></span>
                <span class="absolute left-3/4 top-5 -translate-x-1/2 text-[10px] text-stone-400 md:text-xs"><%= l4 %></span>
                <span class="absolute right-0 top-5 text-[10px] text-stone-400 md:text-xs"><%= l5 %></span>
              </div>
            </div>
          <% end %>
        </div>

        <div class="flex justify-center gap-3 pt-4">
          <%= link_to "キャンセル", product_path(@product), class: "rounded-full border border-stone-200 px-6 py-2 text-sm font-semibold text-stone-600 hover:border-stone-300" %>
          <%= f.submit "送信", class: "rounded-full bg-emerald-500 px-8 py-2 text-sm font-semibold text-white hover:bg-emerald-400" %>
        </div>
      <% end %>
    </div>
  </section>
</main>

<script>
  const initOverallScore = () => {
    const output = document.getElementById("overall-score-value");
    const inputs = document.querySelectorAll('input[name="review[overall_score]"]');
    if (!output || inputs.length === 0) return;

    const update = () => {
      const checked = Array.from(inputs).find((input) => input.checked);
      output.textContent = checked ? `${checked.value}.0/5.0` : "未選択";
    };

    inputs.forEach((input) => input.addEventListener("change", update));
    update();
  };

  document.addEventListener("turbo:load", initOverallScore);
  document.addEventListener("turbo:render", initOverallScore);

</script>
